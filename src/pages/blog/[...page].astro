---
// Misaka Network - Blog List Page (带分页)
import { getCollection } from 'astro:content';
import type { GetStaticPaths } from 'astro';
import Layout from '../../layouts/Layout.astro';
import Card from '../../components/Card.astro';
import NetworkStats from '../../components/NetworkStats.astro';
import Pagination from '../../components/Pagination.astro';
import { sortPostsByTime } from '../../utils/sortPosts';

// 定义分页路径
export const getStaticPaths = (async ({ paginate }) => {
  // 获取所有博客文章，过滤草稿，按文件名时间排序（新文章在前）
  const allPosts = sortPostsByTime(
    (await getCollection('blog')).filter(post => !post.data.draft)
  );

  // 使用 paginate 函数创建分页，每页 5 篇文章
  return paginate(allPosts, {
    pageSize: 5,
  });
}) satisfies GetStaticPaths;

// 从 Astro.props 获取分页数据
const { page } = Astro.props;
---

<Layout
  title={`博客归档 - 第 ${page.currentPage} 页 - Misaka Network`}
  description="所有实验记录与技术文章归档"
>
  <!-- Page Header -->
  <div class="mb-12">
    <h1 class="text-4xl md:text-5xl font-bold mb-4" style="color: var(--text-primary);">
      实验记录归档
    </h1>
    <p class="text-lg font-mono" style="color: var(--text-muted);">
      // Total Experiments: <span class="text-misaka-blue">{page.total}</span>
      {page.currentPage > 1 && (
        <span class="ml-4">
          // Current Page: <span class="text-misaka-circuit">{page.currentPage}</span>
        </span>
      )}
    </p>
    <div class="divider-circuit mt-6"></div>
  </div>

  <!-- Main Content Grid -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
    <!-- Left Column - Blog Posts (占 2/3) -->
    <div class="lg:col-span-2 space-y-8">
      {page.data.map(post => (
        <Card
          title={post.data.title}
          description={post.data.description}
          pubDate={post.data.pubDate}
          heroImage={post.data.heroImage?.src}
          tags={post.data.tags}
          slug={post.id}
        />
      ))}

      {page.data.length === 0 && (
        <div class="network-panel text-center py-12">
          <p class="text-lg" style="color: var(--text-muted);">
            暂无实验记录
          </p>
        </div>
      )}

      <!-- 分页导航 -->
      {page.lastPage > 1 && (
        <Pagination
          currentPage={page.currentPage}
          totalPages={page.lastPage}
          baseUrl="/blog"
        />
      )}
    </div>

    <!-- Right Column - Sidebar (占 1/3) -->
    <div class="space-y-8">
      <NetworkStats />
    </div>
  </div>
</Layout>
