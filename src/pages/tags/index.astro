---
// Misaka Network - Tags Overview Page
import { getCollection } from 'astro:content';
import Layout from '../../layouts/Layout.astro';

// è·å–æ‰€æœ‰å·²å‘å¸ƒçš„åšå®¢æ–‡ç« 
const allPosts = await getCollection('blog', ({ data }) => data.draft !== true);

// æå–æ‰€æœ‰æ ‡ç­¾å¹¶ç»Ÿè®¡æ–‡ç« æ•°é‡
const tagStats = new Map<string, number>();
allPosts.forEach(post => {
    const tags = post.data.tags || [];
    tags.forEach(tag => {
        tagStats.set(tag, (tagStats.get(tag) || 0) + 1);
    });
});

// è½¬æ¢ä¸ºæ•°ç»„å¹¶æŒ‰æ–‡ç« æ•°é‡é™åºæ’åº
const sortedTags = Array.from(tagStats.entries())
    .map(([tag, count]) => ({ tag, count }))
    .sort((a, b) => b.count - a.count);

// è®¡ç®—æ€»æ ‡ç­¾æ•°å’Œæ€»æ–‡ç« æ•°
const totalTags = sortedTags.length;
const totalPosts = allPosts.length;

// é¢„å®šä¹‰çš„æ ‡ç­¾é¢œè‰²æ–¹æ¡ˆï¼ˆå¾ªç¯ä½¿ç”¨ï¼‰
const colorSchemes = [
    { bg: 'rgba(74, 222, 128, 0.1)', border: 'rgba(74, 222, 128, 0.5)', text: '#4ade80', hover: 'rgba(74, 222, 128, 0.2)' }, // ç”µè·¯æ¿ç»¿
    { bg: 'rgba(56, 189, 248, 0.1)', border: 'rgba(56, 189, 248, 0.5)', text: '#38bdf8', hover: 'rgba(56, 189, 248, 0.2)' }, // è¾…åŠ©è“
    { bg: 'rgba(168, 85, 247, 0.1)', border: 'rgba(168, 85, 247, 0.5)', text: '#a855f7', hover: 'rgba(168, 85, 247, 0.2)' }, // ç´«è‰²
    { bg: 'rgba(251, 146, 60, 0.1)', border: 'rgba(251, 146, 60, 0.5)', text: '#fb923c', hover: 'rgba(251, 146, 60, 0.2)' },  // æ©™è‰²
    { bg: 'rgba(244, 63, 94, 0.1)', border: 'rgba(244, 63, 94, 0.5)', text: '#f43f5e', hover: 'rgba(244, 63, 94, 0.2)' },     // ç«çº¢
    { bg: 'rgba(34, 197, 94, 0.1)', border: 'rgba(34, 197, 94, 0.5)', text: '#22c55e', hover: 'rgba(34, 197, 94, 0.2)' },     // ç¿ ç»¿
];
---

<Layout
    title="æ ‡ç­¾å½’æ¡£ - Misaka Network"
    description={`æµè§ˆæ‰€æœ‰ ${totalTags} ä¸ªæ ‡ç­¾ï¼Œæ¶µç›– ${totalPosts} ç¯‡æ–‡ç« `}
>
    <!-- Page Header -->
    <div class="mb-12">
        <nav class="text-sm mb-6 font-mono" style="color: var(--text-muted);">
            <a href="/" class="hover:text-misaka-blue transition-colors">Home</a>
            <span class="mx-2">/</span>
            <a href="/blog" class="hover:text-misaka-blue transition-colors">Blog</a>
            <span class="mx-2">/</span>
            <span class="text-misaka-circuit">Tags</span>
        </nav>

        <div class="flex items-baseline space-x-4 mb-4">
            <h1 class="text-4xl md:text-5xl font-bold font-sans" style="color: var(--text-primary);">
                æ ‡ç­¾å½’æ¡£
            </h1>
            <div class="flex items-center space-x-2 text-sm font-mono" style="color: var(--text-muted);">
                <span class="px-3 py-1 bg-misaka-circuit/20 border border-misaka-circuit/50 rounded-lg text-misaka-circuit">
                    {totalTags} ä¸ªæ ‡ç­¾
                </span>
                <span class="px-3 py-1 bg-misaka-blue/20 border border-misaka-blue/50 rounded-lg text-misaka-blue">
                    {totalPosts} ç¯‡æ–‡ç« 
                </span>
            </div>
        </div>

        <p class="text-lg font-mono" style="color: var(--text-muted);">
            // Explore topics by tags
        </p>

        <div class="divider-circuit mt-6"></div>
    </div>

    <!-- Statistics (Moved to Top) -->
    <div class="mb-12 network-panel">
        <h2 class="text-xl font-bold mb-6 font-sans" style="color: var(--text-primary);">
            ğŸ“Š æ ‡ç­¾ç»Ÿè®¡
        </h2>

        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="stat-item">
                <div class="stat-label">æœ€å¤šæ–‡ç« çš„æ ‡ç­¾</div>
                <div class="stat-value">
                    <a href={`/tags/${sortedTags[0].tag}`} class="hover:text-misaka-circuit transition-colors">
                        #{sortedTags[0].tag}
                    </a>
                    <span class="stat-count">({sortedTags[0].count} ç¯‡)</span>
                </div>
            </div>

            <div class="stat-item">
                <div class="stat-label">æ ‡ç­¾æ€»æ•°</div>
                <div class="stat-value">
                    {totalTags} ä¸ª
                </div>
            </div>

            <div class="stat-item">
                <div class="stat-label">å¹³å‡æ¯ä¸ªæ ‡ç­¾</div>
                <div class="stat-value">
                    {(totalPosts / totalTags).toFixed(1)} ç¯‡
                </div>
            </div>
        </div>

        <!-- Chart Container -->
        <div class="chart-container">
            <h3 class="text-lg font-semibold mb-4 font-sans" style="color: var(--text-secondary);">
                æ ‡ç­¾åˆ†å¸ƒ (Top 10)
            </h3>
            <div class="chart-wrapper">
                <canvas id="tagChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Tags Grid -->
    <div class="mb-8">
        <h2 class="text-xl font-bold mb-6 font-sans" style="color: var(--text-primary);">
            ğŸ·ï¸ æ‰€æœ‰æ ‡ç­¾
        </h2>
    </div>

    {sortedTags.length > 0 && (
        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
            {sortedTags.map(({ tag, count }, index) => {
                const colorScheme = colorSchemes[index % colorSchemes.length];
                return (
                    <a
                        href={`/tags/${tag}`}
                        class="tag-card group"
                        style={`
                            --tag-bg: ${colorScheme.bg};
                            --tag-border: ${colorScheme.border};
                            --tag-text: ${colorScheme.text};
                            --tag-hover: ${colorScheme.hover};
                        `}
                    >
                        <div class="tag-card-content">
                            <div class="tag-icon">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                          d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
                                </svg>
                            </div>
                            <div class="tag-info">
                                <h3 class="tag-name">
                                    #{tag}
                                </h3>
                                <p class="tag-count">
                                    {count} {count === 1 ? 'ç¯‡æ–‡ç« ' : 'ç¯‡æ–‡ç« '}
                                </p>
                            </div>
                            <div class="tag-arrow">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                                </svg>
                            </div>
                        </div>
                    </a>
                );
            })}
        </div>
    )}

    <!-- Back Link -->
    <div class="mt-12 text-center">
        <a
            href="/blog"
            class="inline-flex items-center space-x-2 text-misaka-blue hover:text-misaka-accent transition-colors font-mono"
        >
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
            </svg>
            <span>è¿”å›åšå®¢åˆ—è¡¨</span>
        </a>
    </div>
</Layout>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<!-- Chart Initialization Script -->
<script define:vars={{ sortedTags: sortedTags.slice(0, 10) }}>
    document.addEventListener('DOMContentLoaded', () => {
        const canvas = document.getElementById('tagChart');
        if (!canvas) return;

        // è·å–å½“å‰ä¸»é¢˜
        const isDark = document.documentElement.classList.contains('dark');

        // ä¸»é¢˜é¢œè‰²é…ç½®
        const colors = {
            primary: isDark ? '#4ade80' : '#22c55e',
            secondary: isDark ? '#38bdf8' : '#3b82f6',
            text: isDark ? '#f0f8ff' : '#0f172a',
            grid: isDark ? 'rgba(148, 163, 184, 0.1)' : 'rgba(148, 163, 184, 0.2)',
            background: isDark ? 'rgba(74, 222, 128, 0.1)' : 'rgba(74, 222, 128, 0.2)',
            border: isDark ? 'rgba(74, 222, 128, 0.5)' : 'rgba(74, 222, 128, 0.7)',
        };

        // å‡†å¤‡å›¾è¡¨æ•°æ®
        const labels = sortedTags.map(item => item.tag);
        const data = sortedTags.map(item => item.count);

        // åˆ›å»ºæ¸å˜è‰²
        const ctx = canvas.getContext('2d');
        const gradient = ctx.createLinearGradient(0, 0, canvas.width, 0);
        gradient.addColorStop(0, colors.primary);
        gradient.addColorStop(1, colors.secondary);

        // åˆå§‹åŒ–å›¾è¡¨
        const chart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'æ–‡ç« æ•°é‡',
                    data: data,
                    backgroundColor: colors.background,
                    borderColor: colors.border,
                    borderWidth: 2,
                    borderRadius: 6,
                    hoverBackgroundColor: colors.primary + '40',
                    hoverBorderColor: colors.primary,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                aspectRatio: 2,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: isDark ? 'rgba(30, 41, 59, 0.95)' : 'rgba(255, 255, 255, 0.95)',
                        titleColor: colors.text,
                        bodyColor: colors.text,
                        borderColor: colors.border,
                        borderWidth: 1,
                        padding: 12,
                        displayColors: false,
                        callbacks: {
                            title: (items) => `#${items[0].label}`,
                            label: (item) => `${item.parsed.y} ç¯‡æ–‡ç« `
                        }
                    }
                },
                scales: {
                    x: {
                        grid: {
                            display: false
                        },
                        ticks: {
                            color: colors.text,
                            font: {
                                size: 12
                            },
                            maxRotation: 45,
                            minRotation: 45
                        }
                    },
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: colors.grid,
                            drawBorder: false
                        },
                        ticks: {
                            color: colors.text,
                            font: {
                                size: 12
                            },
                            stepSize: 1,
                            precision: 0
                        }
                    }
                }
            }
        });

        // ç›‘å¬ä¸»é¢˜åˆ‡æ¢
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.attributeName === 'class') {
                    const newIsDark = document.documentElement.classList.contains('dark');

                    // æ›´æ–°é¢œè‰²
                    const newColors = {
                        primary: newIsDark ? '#4ade80' : '#22c55e',
                        secondary: newIsDark ? '#38bdf8' : '#3b82f6',
                        text: newIsDark ? '#f0f8ff' : '#0f172a',
                        grid: newIsDark ? 'rgba(148, 163, 184, 0.1)' : 'rgba(148, 163, 184, 0.2)',
                        background: newIsDark ? 'rgba(74, 222, 128, 0.1)' : 'rgba(74, 222, 128, 0.2)',
                        border: newIsDark ? 'rgba(74, 222, 128, 0.5)' : 'rgba(74, 222, 128, 0.7)',
                    };

                    // æ›´æ–°å›¾è¡¨é…ç½®
                    chart.data.datasets[0].backgroundColor = newColors.background;
                    chart.data.datasets[0].borderColor = newColors.border;
                    chart.data.datasets[0].hoverBackgroundColor = newColors.primary + '40';
                    chart.data.datasets[0].hoverBorderColor = newColors.primary;

                    chart.options.plugins.tooltip.backgroundColor = newIsDark ? 'rgba(30, 41, 59, 0.95)' : 'rgba(255, 255, 255, 0.95)';
                    chart.options.plugins.tooltip.titleColor = newColors.text;
                    chart.options.plugins.tooltip.bodyColor = newColors.text;
                    chart.options.plugins.tooltip.borderColor = newColors.border;

                    chart.options.scales.x.ticks.color = newColors.text;
                    chart.options.scales.y.ticks.color = newColors.text;
                    chart.options.scales.y.grid.color = newColors.grid;

                    chart.update();
                }
            });
        });

        observer.observe(document.documentElement, {
            attributes: true,
            attributeFilter: ['class']
        });
    });
</script>

<style>
    /* å›¾è¡¨å®¹å™¨æ ·å¼ */
    .chart-container {
        margin-top: 1rem;
        padding: 1.5rem;
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        transition: all 0.3s ease;
    }

    .chart-container:hover {
        border-color: rgba(74, 222, 128, 0.4);
        box-shadow: 0 4px 12px rgba(74, 222, 128, 0.1);
    }

    .chart-wrapper {
        position: relative;
        width: 100%;
        max-width: 100%;
        margin: 0 auto;
    }

    @media (max-width: 768px) {
        .chart-container {
            padding: 1rem;
        }

        .chart-wrapper {
            max-width: 100%;
        }
    }

    /* æ ‡ç­¾å¡ç‰‡æ ·å¼ */
    .tag-card {
        display: block;
        text-decoration: none;
        background: var(--tag-bg);
        border: 1px solid var(--tag-border);
        border-radius: 12px;
        padding: 1.25rem;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }

    .tag-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: var(--tag-hover);
        opacity: 0;
        transition: opacity 0.3s ease;
        z-index: 0;
    }

    .tag-card:hover::before {
        opacity: 1;
    }

    .tag-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
        border-color: var(--tag-text);
    }

    .tag-card-content {
        position: relative;
        z-index: 1;
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .tag-icon {
        flex-shrink: 0;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--bg-secondary);
        border-radius: 8px;
        color: var(--tag-text);
        transition: all 0.3s ease;
    }

    .tag-card:hover .tag-icon {
        transform: rotate(12deg) scale(1.1);
        background: var(--tag-text);
        color: var(--bg-primary);
    }

    .tag-info {
        flex: 1;
        min-width: 0;
    }

    .tag-name {
        font-size: 1.125rem;
        font-weight: 600;
        color: var(--tag-text);
        margin: 0;
        line-height: 1.4;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .tag-count {
        font-size: 0.875rem;
        color: var(--text-muted);
        margin: 0;
        margin-top: 0.25rem;
    }

    .tag-arrow {
        flex-shrink: 0;
        color: var(--tag-text);
        opacity: 0;
        transform: translateX(-8px);
        transition: all 0.3s ease;
    }

    .tag-card:hover .tag-arrow {
        opacity: 1;
        transform: translateX(0);
    }

    /* ç»Ÿè®¡é¡¹æ ·å¼ */
    .stat-item {
        text-align: center;
        padding: 1.5rem;
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        transition: all 0.3s ease;
    }

    .stat-item:hover {
        border-color: var(--misaka-circuit);
        box-shadow: 0 4px 12px rgba(74, 222, 128, 0.1);
    }

    .stat-label {
        font-size: 0.875rem;
        color: var(--text-muted);
        margin-bottom: 0.5rem;
    }

    .stat-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-primary);
    }

    .stat-count {
        font-size: 1rem;
        color: var(--text-muted);
        font-weight: 400;
        margin-left: 0.5rem;
    }

    /* å“åº”å¼ä¼˜åŒ– */
    @media (max-width: 640px) {
        .tag-card {
            padding: 1rem;
        }

        .tag-icon {
            width: 36px;
            height: 36px;
        }

        .tag-name {
            font-size: 1rem;
        }

        .tag-count {
            font-size: 0.75rem;
        }

        .stat-value {
            font-size: 1.25rem;
        }
    }

    /* æ·±è‰²æ¨¡å¼ä¼˜åŒ– */
    :global(.dark) .tag-card {
        background: var(--tag-bg);
    }

    :global(.dark) .tag-icon {
        background: rgba(30, 41, 59, 0.8);
    }

    :global(.dark) .tag-card:hover .tag-icon {
        background: var(--tag-text);
    }

    :global(.dark) .stat-item {
        background: rgba(30, 41, 59, 0.5);
    }
</style>
