---
// MermaidViewer.astro - Mermaid 流程图全屏查看器
// 支持拖拽和缩放功能
---

<!-- 全屏查看器模态框 -->
<div id="mermaid-viewer" class="mermaid-viewer" role="dialog" aria-modal="true" aria-hidden="true">
  <!-- 背景遮罩 -->
  <div class="mermaid-viewer-backdrop"></div>

  <!-- 内容容器 -->
  <div class="mermaid-viewer-container">
    <!-- 工具栏 -->
    <div class="mermaid-viewer-toolbar">
      <div class="toolbar-info">
        <span class="toolbar-title">流程图查看器</span>
        <span class="toolbar-hint">拖拽移动 · 滚轮缩放</span>
      </div>
      <div class="toolbar-controls">
        <button id="reset-zoom" class="toolbar-button" title="重置视图 (R)">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
               stroke="currentColor" class="w-5 h-5">
            <path stroke-linecap="round" stroke-linejoin="round"
                  d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99"/>
          </svg>
        </button>
        <button id="close-viewer" class="toolbar-button" title="关闭 (ESC)">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
               stroke="currentColor" class="w-5 h-5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      </div>
    </div>

    <!-- SVG 容器 (可拖拽和缩放) -->
    <div id="svg-viewport" class="mermaid-viewer-viewport">
      <div id="svg-content" class="mermaid-viewer-content">
        <!-- SVG 将被动态插入这里 -->
      </div>
    </div>

    <!-- 缩放指示器 -->
    <div class="zoom-indicator">
      <span id="zoom-level">100%</span>
    </div>
  </div>
</div>

<script>
  // 查看器状态
  let isOpen = false;
  let scale = 1;
  let translateX = 0;
  let translateY = 0;
  let isDragging = false;
  let startX = 0;
  let startY = 0;

  // 获取 DOM 元素
  const viewer = document.getElementById('mermaid-viewer');
  const backdrop = viewer?.querySelector('.mermaid-viewer-backdrop');
  const svgContent = document.getElementById('svg-content');
  const svgViewport = document.getElementById('svg-viewport');
  const closeButton = document.getElementById('close-viewer');
  const resetButton = document.getElementById('reset-zoom');
  const zoomIndicator = document.getElementById('zoom-level');

  // 打开查看器
  function openViewer(svgHTML: string) {
    if (!viewer || !svgContent) return;

    // 插入 SVG 内容
    svgContent.innerHTML = svgHTML;

    // 重置状态
    resetView();

    // 显示查看器
    viewer.classList.add('active');
    viewer.setAttribute('aria-hidden', 'false');
    document.body.style.overflow = 'hidden';
    isOpen = true;
  }

  // 关闭查看器
  function closeViewer() {
    if (!viewer) return;

    viewer.classList.remove('active');
    viewer.setAttribute('aria-hidden', 'true');
    document.body.style.overflow = '';
    isOpen = false;

    // 延迟清空内容，等待动画完成
    setTimeout(() => {
      if (svgContent) svgContent.innerHTML = '';
    }, 300);
  }

  // 重置视图
  function resetView() {
    scale = 1;
    translateX = 0;
    translateY = 0;
    updateTransform();
  }

  // 更新变换
  function updateTransform() {
    if (!svgContent) return;

    svgContent.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale})`;

    // 更新缩放指示器
    if (zoomIndicator) {
      zoomIndicator.textContent = `${Math.round(scale * 100)}%`;
    }
  }

  // 鼠标按下开始拖拽
  function handleMouseDown(e: MouseEvent) {
    if (!isOpen) return;

    isDragging = true;
    startX = e.clientX - translateX;
    startY = e.clientY - translateY;

    if (svgViewport) {
      svgViewport.style.cursor = 'grabbing';
    }
  }

  // 鼠标移动拖拽
  function handleMouseMove(e: MouseEvent) {
    if (!isDragging || !isOpen) return;

    translateX = e.clientX - startX;
    translateY = e.clientY - startY;
    updateTransform();
  }

  // 鼠标释放停止拖拽
  function handleMouseUp() {
    isDragging = false;
    if (svgViewport) {
      svgViewport.style.cursor = 'grab';
    }
  }

  // 鼠标滚轮缩放
  function handleWheel(e: WheelEvent) {
    if (!isOpen) return;

    e.preventDefault();

    // 计算缩放中心点
    const rect = svgViewport?.getBoundingClientRect();
    if (!rect) return;

    const mouseX = e.clientX - rect.left;
    const mouseY = e.clientY - rect.top;

    // 计算缩放前的坐标
    const beforeX = (mouseX - translateX) / scale;
    const beforeY = (mouseY - translateY) / scale;

    // 计算新的缩放级别
    const delta = e.deltaY > 0 ? 0.9 : 1.1;
    const newScale = Math.max(0.1, Math.min(10, scale * delta));

    // 计算缩放后的坐标
    const afterX = beforeX * newScale;
    const afterY = beforeY * newScale;

    // 调整平移以保持鼠标位置不变
    translateX = mouseX - afterX;
    translateY = mouseY - afterY;

    scale = newScale;
    updateTransform();
  }

  // 键盘事件
  function handleKeyDown(e: KeyboardEvent) {
    if (!isOpen) return;

    switch (e.key) {
      case 'Escape':
        closeViewer();
        break;
      case 'r':
      case 'R':
        resetView();
        break;
      case '+':
      case '=':
        scale = Math.min(10, scale * 1.2);
        updateTransform();
        break;
      case '-':
      case '_':
        scale = Math.max(0.1, scale * 0.8);
        updateTransform();
        break;
    }
  }

  // 监听打开查看器事件
  window.addEventListener('open-mermaid-viewer', ((e: CustomEvent) => {
    const {svg} = e.detail;
    if (svg) {
      openViewer(svg);
    }
  }) as EventListener);

  // 点击关闭按钮
  closeButton?.addEventListener('click', closeViewer);

  // 点击背景关闭
  backdrop?.addEventListener('click', closeViewer);

  // 点击重置按钮
  resetButton?.addEventListener('click', resetView);

  // 拖拽事件
  svgViewport?.addEventListener('mousedown', handleMouseDown);
  window.addEventListener('mousemove', handleMouseMove);
  window.addEventListener('mouseup', handleMouseUp);

  // 滚轮缩放事件
  svgViewport?.addEventListener('wheel', handleWheel, {passive: false});

  // 键盘事件
  window.addEventListener('keydown', handleKeyDown);
</script>

<style>
  /* 查看器容器 */
  .mermaid-viewer {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: 9999;
    display: none;
    align-items: center;
    justify-content: center;
  }

  .mermaid-viewer.active {
    display: flex;
  }

  /* 背景遮罩 */
  .mermaid-viewer-backdrop {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0, 0, 0, 0.8);
    backdrop-filter: blur(4px);
    animation: fadeIn 0.2s ease;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
    }
    to {
      opacity: 1;
    }
  }

  /* 内容容器 */
  .mermaid-viewer-container {
    position: relative;
    width: 95vw;
    height: 95vh;
    background-color: var(--bg-primary);
    border: 2px solid var(--border-color);
    border-radius: 0.75rem;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    animation: slideIn 0.3s ease;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
  }

  @keyframes slideIn {
    from {
      transform: scale(0.9);
      opacity: 0;
    }
    to {
      transform: scale(1);
      opacity: 1;
    }
  }

  /* 工具栏 */
  .mermaid-viewer-toolbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 1.5rem;
    background-color: var(--bg-secondary);
    border-bottom: 1px solid var(--border-color);
    gap: 1rem;
  }

  .toolbar-info {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  .toolbar-title {
    font-size: 1rem;
    font-weight: 600;
    color: var(--text-primary);
  }

  .toolbar-hint {
    font-size: 0.75rem;
    color: var(--text-muted);
  }

  .toolbar-controls {
    display: flex;
    gap: 0.5rem;
  }

  .toolbar-button {
    padding: 0.5rem;
    background-color: transparent;
    border: 1px solid var(--border-color);
    border-radius: 0.375rem;
    color: var(--text-primary);
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .toolbar-button:hover {
    background-color: rgba(74, 222, 128, 0.1);
    border-color: #4ade80;
    color: #4ade80;
  }

  .toolbar-button:active {
    transform: scale(0.95);
  }

  /* SVG 视口 */
  .mermaid-viewer-viewport {
    flex: 1;
    overflow: hidden;
    position: relative;
    cursor: grab;
    background-color: var(--bg-primary);
  }

  .mermaid-viewer-viewport:active {
    cursor: grabbing;
  }

  /* SVG 内容 */
  .mermaid-viewer-content {
    position: absolute;
    top: 50%;
    left: 50%;
    transform-origin: center center;
    transition: transform 0.1s ease-out;
    will-change: transform;
  }

  .mermaid-viewer-content :global(svg) {
    display: block;
    transform: translate(-50%, -50%);
  }

  /* 缩放指示器 */
  .zoom-indicator {
    position: absolute;
    bottom: 1.5rem;
    left: 50%;
    transform: translateX(-50%);
    padding: 0.5rem 1rem;
    background-color: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 9999px;
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--text-primary);
    pointer-events: none;
    opacity: 0.9;
  }

  /* 响应式适配 */
  @media (max-width: 768px) {
    .mermaid-viewer-container {
      width: 100vw;
      height: 100vh;
      border-radius: 0;
    }

    .mermaid-viewer-toolbar {
      padding: 0.75rem 1rem;
    }

    .toolbar-title {
      font-size: 0.875rem;
    }

    .toolbar-hint {
      display: none;
    }

    .zoom-indicator {
      bottom: 1rem;
      font-size: 0.75rem;
      padding: 0.375rem 0.75rem;
    }
  }
</style>
