---
// Misaka Network - ä¸»é¢˜åˆ‡æ¢æŒ‰é’®ç»„ä»¶
---

<button id="theme-toggle" class="theme-toggle" aria-label="åˆ‡æ¢ä¸»é¢˜" title="åˆ‡æ¢ä¸»é¢˜">
  <svg class="sun-icon" width="22" height="22" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
    <path
      d="M10 3V1M10 19V17M17 10H19M1 10H3M15.5 15.5L16.9 16.9M3.1 3.1L4.5 4.5M15.5 4.5L16.9 3.1M3.1 16.9L4.5 15.5M14 10C14 12.2091 12.2091 14 10 14C7.79086 14 6 12.2091 6 10C6 7.79086 7.79086 6 10 6C12.2091 6 14 7.79086 14 10Z"
      stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
  </svg>
  <svg class="moon-icon" width="22" height="22" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
    <path
      d="M17.9 13.4C17.6 13.8 17.2 14.1 16.7 14.4C15 15.4 12.9 15.6 11 14.9C9.10001 14.2 7.60001 12.7 6.90001 10.8C6.20001 8.90001 6.40001 6.80001 7.40001 5.10001C7.70001 4.60001 8.10001 4.20001 8.50001 3.80001C6.20001 4.00001 4.10001 5.20001 2.80001 7.10001C0.900006 9.90001 1.40001 13.7 3.90001 15.9C6.40001 18.1 10.2 18.1 12.7 16C14.6 14.7 15.8 12.6 16 10.3C15.9 11.4 17.9 13.4 17.9 13.4Z"
      stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
  </svg>
</button>

<style>
  .theme-toggle {
    background: none;
    border: 1px solid transparent;
    cursor: pointer;
    padding: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text-secondary);
    transition: all 0.3s ease;
    border-radius: 8px;
  }

  .theme-toggle:hover {
    transform: scale(1.1);
    background-color: var(--bg-secondary);
    border-color: var(--border-color);
    color: var(--misaka-blue);
  }

  .theme-toggle:focus {
    outline: 2px solid var(--misaka-blue);
    outline-offset: 2px;
  }

  /* æµ…è‰²æ¨¡å¼æ˜¾ç¤ºå¤ªé˜³å›¾æ ‡ */
  :root:not(.dark) .sun-icon {
    display: block;
  }

  :root:not(.dark) .moon-icon {
    display: none;
  }

  /* æ·±è‰²æ¨¡å¼æ˜¾ç¤ºæœˆäº®å›¾æ ‡ */
  :global(.dark) .sun-icon {
    display: none;
  }

  :global(.dark) .moon-icon {
    display: block;
  }

  /* å›¾æ ‡åŠ¨ç”» */
  .theme-toggle svg {
    transition: transform 0.3s ease;
  }

  .theme-toggle:active svg {
    transform: rotate(180deg);
  }
</style>

<script>
  // ğŸ”§ å¼€å‘/ç”Ÿäº§ç¯å¢ƒæ£€æµ‹
  const IS_DEV = import.meta.env.DEV;
  const log = (...args) => IS_DEV && console.log(...args);

  // é˜²æ­¢é‡å¤ç»‘å®šçš„æ ‡å¿—ä½
  let isThemeToggleInitialized = false;

  // ä¸»é¢˜åˆ‡æ¢é€»è¾‘
  function setupThemeToggle() {
    // é˜²æ­¢é‡å¤åˆå§‹åŒ–
    if (isThemeToggleInitialized) {
      log('[ThemeToggle] Already initialized, skipping...');
      return;
    }

    const button = document.getElementById('theme-toggle');

    if (!button) return;

    button.addEventListener('click', () => {
      const root = document.documentElement;
      const isDark = root.classList.contains('dark');

      // åˆ‡æ¢ä¸»é¢˜
      if (isDark) {
        root.classList.remove('dark');
        localStorage.setItem('theme', 'light');
      } else {
        root.classList.add('dark');
        localStorage.setItem('theme', 'dark');
      }

      // ğŸ¯ å‘é€è‡ªå®šä¹‰äº‹ä»¶ï¼Œé€šçŸ¥å…¶ä»–ç»„ä»¶ä¸»é¢˜å·²åˆ‡æ¢
      const newTheme = isDark ? 'light' : 'dark';
      log(`[ThemeToggle] Dispatching theme-changed event: ${newTheme}`);

      window.dispatchEvent(new CustomEvent('theme-changed', {
        detail: {
          theme: newTheme,
          timestamp: Date.now()
        }
      }));
    });

    isThemeToggleInitialized = true;
    log('[ThemeToggle] Initialized successfully');
  }

  // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
  setupThemeToggle();

  // æ”¯æŒ View Transitionsï¼ˆå¦‚æœæµè§ˆå™¨æ”¯æŒï¼‰
  document.addEventListener('astro:page-load', setupThemeToggle);
</script>
