---
// å´©æºƒæ£€æµ‹ç»„ä»¶ - ç”¨äºæ£€æµ‹é¡µé¢æ— å“åº”æƒ…å†µ
---

<script>
  // ğŸš¨ å´©æºƒæ£€æµ‹å™¨ - æ£€æµ‹é¡µé¢æ˜¯å¦å“åº”
  const CRASH_DETECTOR_ENABLED = true;
  const HEARTBEAT_INTERVAL = 1000;  // æ¯ç§’å¿ƒè·³
  const MAX_FREEZE_TIME = 3000;     // è¶…è¿‡ 3 ç§’è§†ä¸ºå†»ç»“

  if (CRASH_DETECTOR_ENABLED) {
    console.log('[CrashDetector] ğŸš¨ Crash detector enabled');

    let lastHeartbeat = Date.now();
    let freezeCount = 0;

    // ä¸»çº¿ç¨‹å¿ƒè·³æ£€æµ‹
    setInterval(() => {
      const now = Date.now();
      const timeSinceLastBeat = now - lastHeartbeat;

      if (timeSinceLastBeat > MAX_FREEZE_TIME) {
        freezeCount++;
        console.error('[CrashDetector] âš ï¸âš ï¸âš ï¸ PAGE FREEZE DETECTED!');
        console.error('[CrashDetector] Freeze duration:', timeSinceLastBeat, 'ms');
        console.error('[CrashDetector] Freeze count:', freezeCount);
        console.error('[CrashDetector] This indicates a blocking operation or infinite loop!');

        // æ‰“å°å †æ ˆè·Ÿè¸ª
        console.error('[CrashDetector] Current stack trace:');
        console.trace();
      }

      lastHeartbeat = now;
    }, HEARTBEAT_INTERVAL);

    // ç›‘å¬é¡µé¢å¯è§æ€§å˜åŒ–
    document.addEventListener('visibilitychange', () => {
      if (document.hidden) {
        console.log('[CrashDetector] ğŸ“´ Page hidden');
      } else {
        console.log('[CrashDetector] ğŸ‘ï¸ Page visible again');
        lastHeartbeat = Date.now();  // é‡ç½®å¿ƒè·³
        freezeCount = 0;
      }
    });

    // ç›‘å¬æµè§ˆå™¨å¡æ­»å‰çš„è­¦å‘Š
    window.addEventListener('beforeunload', () => {
      console.log('[CrashDetector] ğŸšª Page about to unload');
    });

    // å®šæœŸæŠ¥å‘ŠçŠ¶æ€
    setInterval(() => {
      console.log('[CrashDetector] ğŸ’“ Heartbeat OK -', new Date().toISOString());
    }, 5000);  // æ¯ 5 ç§’æŠ¥å‘Šä¸€æ¬¡

    console.log('[CrashDetector] âœ… Monitoring started');
  }
</script>
