---
// MermaidRendererOptimized.astro - ä¼˜åŒ–ç‰ˆ Mermaid æ¸²æŸ“å™¨
// ä½¿ç”¨æ‡’åŠ è½½ + æ¸²æŸ“é˜Ÿåˆ—é¿å…è¶…æ—¶å’Œé˜»å¡
---

<!-- Mermaid æ¸²æŸ“å®¹å™¨ -->
<div id="mermaid-container" class="hidden"></div>

<script>
  // ğŸ”§ è°ƒè¯•æ¨¡å¼
  const DEBUG_MODE = false;  // è®¾ç½®ä¸º false å¯å…³é—­è°ƒè¯•
  const log = (...args) => DEBUG_MODE && console.log('[Mermaid]', new Date().toISOString(), ...args);
  const logError = (...args) => console.error('[Mermaid ERROR]', new Date().toISOString(), ...args);
  const logWarn = (...args) => console.warn('[Mermaid WARN]', new Date().toISOString(), ...args);

  log('ğŸš€ Optimized Mermaid Renderer loaded');

  // é˜²æ­¢é‡å¤åˆå§‹åŒ–çš„æ ‡å¿—ä½
  let isInitialized = false;
  let isInitializing = false;
  let hasInitializedOnce = false;

  // ä¿å­˜æ‰€æœ‰ Mermaid å›¾è¡¨çš„åŸå§‹ä»£ç 
  const mermaidDiagrams = [];

  // ğŸ¯ æ¸²æŸ“é˜Ÿåˆ— - é¿å…åŒæ—¶æ¸²æŸ“å¤ªå¤šå›¾è¡¨
  const renderQueue = [];
  let isRendering = false;
  let totalDiagramsExpected = 0;  // é¢„æœŸè¦æ¸²æŸ“çš„å›¾è¡¨æ€»æ•°

  // ğŸ”§ æ¸²æŸ“å®Œæˆçš„ Promiseï¼Œç”¨äºç­‰å¾…æ¸²æŸ“å®Œæˆ
  let renderCompletionPromise = null;
  let renderCompletionResolve = null;

  // åŠ¨æ€åŠ è½½ Mermaid.js
  async function loadMermaid() {
    log('ğŸ“¦ loadMermaid() called');

    if (typeof window.mermaid !== 'undefined') {
      log('âœ… Mermaid already loaded');
      return window.mermaid;
    }

    log('â¬‡ï¸ Loading Mermaid from CDN...');

    return new Promise((resolve, reject) => {
      const script = document.createElement('script');
      script.src = 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js';
      script.type = 'module';
      script.onload = () => {
        log('âœ… Mermaid CDN script loaded');
        if (window.mermaid) {
          resolve(window.mermaid);
        } else {
          logError('âŒ window.mermaid not available after load');
          reject(new Error('Mermaid failed to load'));
        }
      };
      script.onerror = () => {
        logError('âŒ Failed to load Mermaid script from CDN');
        reject(new Error('Failed to load Mermaid script'));
      };
      document.head.appendChild(script);
    });
  }

  // ğŸ¯ æ¸²æŸ“å•ä¸ªå›¾è¡¨ï¼ˆå¸¦é‡è¯•æœºåˆ¶ï¼‰
  async function renderSingleDiagram(block, index, mermaid) {
    // ğŸ”§ æ£€æŸ¥å…ƒç´ æ˜¯å¦ä»åœ¨ DOM ä¸­
    if (!block || !block.isConnected) {
      logWarn(`âš ï¸ Diagram ${index}: element not in DOM, skipping`);
      return null;
    }

    const pre = block.parentElement;
    if (!pre || !pre.isConnected) {
      logWarn(`âš ï¸ Diagram ${index}: parent element not in DOM, skipping`);
      return null;
    }

    const code = block.textContent || block.innerText || '';

    if (!code.trim()) {
      logWarn(`âš ï¸ Skipping empty diagram ${index}`);
      return null;
    }

    try {
      log(`ğŸ¨ Rendering diagram ${index}...`);

      // åˆ›å»ºå®¹å™¨
      const wrapper = document.createElement('div');
      wrapper.className = 'mermaid-wrapper my-8 relative';

      const container = document.createElement('div');
      container.className = 'mermaid-diagram flex justify-center';
      container.style.cssText = `
        background-color: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 0.5rem;
        padding: 2rem;
        overflow-x: auto;
      `;

      // ğŸš€ æ¸²æŸ“ï¼ˆä¸ä½¿ç”¨è¶…æ—¶ï¼Œè®©æµè§ˆå™¨è‡ªå·±å†³å®šï¼‰
      log(`â° Start rendering diagram ${index} at:`, new Date().toISOString());

      const renderResult = await mermaid.render(`mermaid-${index}-${Date.now()}`, code);
      const { svg } = renderResult;

      log(`âœ… Diagram ${index} rendered successfully!`);
      log(`ğŸ“ SVG length: ${svg.length} chars`);

      container.innerHTML = svg;

      // åˆ›å»ºæ”¾å¤§æŒ‰é’®
      const zoomButton = document.createElement('button');
      zoomButton.className = 'mermaid-zoom-button';
      zoomButton.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
          <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3.75v4.5m0-4.5h4.5m-4.5 0L9 9M3.75 20.25v-4.5m0 4.5h4.5m-4.5 0L9 15M20.25 3.75h-4.5m4.5 0v4.5m0-4.5L15 9m5.25 11.25h-4.5m4.5 0v-4.5m0 4.5L15 15" />
        </svg>
      `;
      zoomButton.setAttribute('aria-label', 'å…¨å±æŸ¥çœ‹æµç¨‹å›¾');
      zoomButton.setAttribute('title', 'å…¨å±æŸ¥çœ‹ (æ”¯æŒæ‹–æ‹½å’Œç¼©æ”¾)');

      zoomButton.addEventListener('click', () => {
        const svgElement = container.querySelector('svg');
        if (svgElement) {
          window.dispatchEvent(new CustomEvent('open-mermaid-viewer', {
            detail: { svg: svgElement.outerHTML, id: `mermaid-${index}` }
          }));
        }
      });

      wrapper.appendChild(container);
      wrapper.appendChild(zoomButton);

      // ğŸ”§ å†æ¬¡æ£€æŸ¥çˆ¶å…ƒç´ æ˜¯å¦ä»åœ¨ DOM ä¸­
      if (!pre.isConnected || !pre.parentElement) {
        logWarn(`âš ï¸ Diagram ${index}: parent element removed during rendering`);
        return null;
      }

      // æ›¿æ¢åŸå§‹ä»£ç å—
      pre.parentElement.replaceChild(wrapper, pre);

      // ä¿å­˜å›¾è¡¨ä¿¡æ¯
      mermaidDiagrams.push({
        id: `mermaid-${index}`,
        code: code,
        wrapper: wrapper,
        container: container
      });

      log(`âœ… Diagram ${index} inserted into DOM`);
      return wrapper;
    } catch (error) {
      logError(`âŒ Rendering error for diagram ${index}:`);
      logError(`   Error message: ${error.message}`);
      logError(`   Failed code (first 200 chars):`, code.substring(0, 200));

      // æ¸²æŸ“å¤±è´¥æ—¶æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
      const errorDiv = document.createElement('div');
      errorDiv.className = 'mermaid-error p-4 my-4 rounded-lg';
      errorDiv.style.cssText = `
        background-color: rgba(239, 68, 68, 0.1);
        border: 1px solid rgba(239, 68, 68, 0.3);
        color: var(--text-primary);
      `;
      errorDiv.innerHTML = `
        <p class="font-semibold mb-2">âš ï¸ Mermaid æ¸²æŸ“å¤±è´¥ (å›¾è¡¨ #${index})</p>
        <p class="text-sm mb-2">é”™è¯¯ä¿¡æ¯: ${error.message}</p>
        <details class="text-xs">
          <summary class="cursor-pointer hover:text-misaka-blue">æŸ¥çœ‹ä»£ç </summary>
          <pre class="mt-2 p-2 bg-black bg-opacity-20 rounded overflow-x-auto"><code>${code}</code></pre>
        </details>
      `;

      if (pre && pre.parentElement && pre.isConnected) {
        pre.parentElement.insertBefore(errorDiv, pre);
        pre.remove();
      }

      return null;
    }
  }

  // ğŸ¯ å¤„ç†æ¸²æŸ“é˜Ÿåˆ—ï¼ˆé€ä¸ªæ¸²æŸ“ï¼Œé¿å…é˜»å¡ï¼‰
  async function processRenderQueue(mermaid) {
    if (isRendering) {
      log('âš ï¸ Already rendering, skipping duplicate call');
      return;
    }

    if (renderQueue.length === 0) {
      log('â„¹ï¸ Render queue is empty');
      return;
    }

    isRendering = true;
    const totalToRender = renderQueue.length;
    log(`ğŸ”„ Processing render queue (${totalToRender} items)...`);

    // ğŸ”§ åˆ›å»ºæ¸²æŸ“å®Œæˆ Promise
    renderCompletionPromise = new Promise(resolve => {
      renderCompletionResolve = resolve;
    });

    let renderedCount = 0;

    while (renderQueue.length > 0) {
      const { block, index } = renderQueue.shift();

      log(`ğŸ“Š Rendering ${renderedCount + 1}/${totalToRender} (diagram #${index})`);

      await renderSingleDiagram(block, index, mermaid);
      renderedCount++;

      // ğŸ”§ æ¯æ¸²æŸ“ä¸€ä¸ªå›¾è¡¨åï¼Œç»™æµè§ˆå™¨ä¸€ç‚¹æ—¶é—´å¤„ç†å…¶ä»–ä»»åŠ¡
      await new Promise(resolve => setTimeout(resolve, 100));
    }

    isRendering = false;
    log(`âœ… Queue processing complete. Rendered: ${renderedCount}/${totalToRender}`);
    log(`ğŸ“Š Total diagrams in cache: ${mermaidDiagrams.length}`);

    // ğŸ”§ æ ‡è®°æ¸²æŸ“å®Œæˆ
    if (renderCompletionResolve) {
      renderCompletionResolve();
      renderCompletionResolve = null;
    }
  }

  // åˆå§‹åŒ– Mermaid
  async function initMermaid() {
    log('ğŸ¬ initMermaid() called');

    // æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰æ¸²æŸ“å¥½çš„å›¾è¡¨
    const existingDiagrams = document.querySelectorAll('.mermaid-wrapper');
    const newMermaidBlocks = document.querySelectorAll('pre[data-language="mermaid"] code');

    log(`ğŸ“Š Existing diagrams: ${existingDiagrams.length}`);
    log(`ğŸ“Š New mermaid blocks: ${newMermaidBlocks.length}`);

    // ğŸ”§ å¦‚æœå·²ç»æ¸²æŸ“å®Œæˆï¼ˆå›¾è¡¨æ•°é‡ç­‰äºé¢„æœŸæ•°é‡ï¼‰ï¼Œè·³è¿‡
    if (existingDiagrams.length > 0 &&
        newMermaidBlocks.length === 0 &&
        hasInitializedOnce &&
        !isRendering) {
      log('âœ… All diagrams already rendered, skipping');
      return;
    }

    if (isInitialized || isInitializing) {
      logWarn('âš ï¸ Already initialized or initializing, skipping');
      return;
    }

    isInitializing = true;

    try {
      log('ğŸ” Searching for mermaid blocks...');

      const mermaidBlocks = document.querySelectorAll('pre[data-language="mermaid"] code');
      log(`ğŸ“‹ Found ${mermaidBlocks.length} mermaid blocks`);

      if (mermaidBlocks.length === 0) {
        log('â„¹ï¸ No mermaid blocks found');
        isInitializing = false;
        isInitialized = true;
        return;
      }

      log('ğŸ“¦ Loading Mermaid library...');
      const mermaid = await loadMermaid();
      log('âœ… Mermaid library loaded');

      // é…ç½® Mermaid
      const isDark = document.documentElement.classList.contains('dark');
      log('ğŸ¨ Theme:', isDark ? 'dark' : 'light');

      mermaid.initialize({
        startOnLoad: false,
        theme: isDark ? 'dark' : 'default',
        themeVariables: {
          primaryColor: isDark ? '#4ade80' : '#4ade80',
          primaryTextColor: isDark ? '#f0f8ff' : '#0f172a',
          primaryBorderColor: isDark ? '#4ade80' : '#4ade80',
          lineColor: isDark ? '#38bdf8' : '#38bdf8',
          secondaryColor: isDark ? '#1e293b' : '#e0f2fe',
          tertiaryColor: isDark ? '#0f172a' : '#f0f9ff',
          fontFamily: 'system-ui, -apple-system, sans-serif',
          fontSize: '14px',
        },
        flowchart: {
          curve: 'basis',
          padding: 20,
          nodeSpacing: 50,
          rankSpacing: 50,
          htmlLabels: true,
        },
        sequence: {
          actorMargin: 50,
          width: 150,
          height: 65,
          boxMargin: 10,
        },
        securityLevel: 'loose',
        suppressErrorRendering: false,
      });

      log('âœ… Mermaid initialized');

      // ğŸ¯ å°†æ‰€æœ‰å›¾è¡¨æ·»åŠ åˆ°é˜Ÿåˆ—
      renderQueue.length = 0;  // æ¸…ç©ºé˜Ÿåˆ—
      totalDiagramsExpected = mermaidBlocks.length;  // è®¾ç½®é¢„æœŸæ•°é‡

      mermaidBlocks.forEach((block, index) => {
        renderQueue.push({ block, index });
      });

      log(`ğŸ“‹ Added ${renderQueue.length} diagrams to render queue`);
      log(`ğŸ¯ Expected to render: ${totalDiagramsExpected} diagrams`);

      // ğŸš€ å¼€å§‹å¤„ç†é˜Ÿåˆ—
      await processRenderQueue(mermaid);

      // ğŸ”§ ç­‰å¾…æ¸²æŸ“å®Œæˆ
      if (renderCompletionPromise) {
        log('â³ Waiting for all diagrams to render...');
        await renderCompletionPromise;
        log('âœ… All rendering complete');
      }

      log('ğŸ‰ All diagrams processed!');

    } catch (error) {
      logError('âŒ FATAL ERROR during initialization:');
      logError('   Error message:', error.message);
      logError('   Error stack:', error.stack);
      isInitializing = false;
    } finally {
      if (!isInitialized) {
        isInitialized = true;
        isInitializing = false;
        hasInitializedOnce = true;
        log('âœ… Initialization complete. Total diagrams:', mermaidDiagrams.length);
      }
    }
  }

  // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
  function initOnPageLoad() {
    log('\nğŸ”„ ========== PAGE LOAD EVENT ==========');
    initMermaid();
  }

  log('ğŸ“Œ Setting up event listeners...');

  if (document.readyState === 'loading') {
    log('â³ Waiting for DOMContentLoaded...');
    document.addEventListener('DOMContentLoaded', initOnPageLoad);
  } else {
    log('âœ… DOM ready, initializing...');
    initOnPageLoad();
  }

  // ä¸»é¢˜åˆ‡æ¢æ”¯æŒï¼ˆé‡æ–°æ¸²æŸ“æ‰€æœ‰å›¾è¡¨ï¼‰
  window.addEventListener('theme-changed', async (event) => {
    const { theme } = event.detail;
    log(`ğŸ¨ Theme changed to: ${theme}`);

    // ğŸ”§ å¦‚æœæ­£åœ¨åˆå§‹åŒ–æˆ–æ¸²æŸ“ï¼Œå»¶è¿Ÿä¸»é¢˜åˆ‡æ¢
    if (isRendering) {
      logWarn('âš ï¸ Rendering in progress, delaying theme change...');
      // ç­‰å¾…ä¸€æ®µæ—¶é—´åé‡è¯•
      setTimeout(() => {
        window.dispatchEvent(new CustomEvent('theme-changed', { detail: { theme } }));
      }, 500);
      return;
    }

    if (mermaidDiagrams.length === 0) {
      log('â„¹ï¸ No diagrams to rerender');
      return;
    }

    try {
      const mermaid = await loadMermaid();
      const isDark = document.documentElement.classList.contains('dark');

      mermaid.initialize({
        startOnLoad: false,
        theme: isDark ? 'dark' : 'default',
        themeVariables: {
          primaryColor: isDark ? '#4ade80' : '#4ade80',
          primaryTextColor: isDark ? '#f0f8ff' : '#0f172a',
          primaryBorderColor: isDark ? '#4ade80' : '#4ade80',
          lineColor: isDark ? '#38bdf8' : '#38bdf8',
          secondaryColor: isDark ? '#1e293b' : '#e0f2fe',
          tertiaryColor: isDark ? '#0f172a' : '#f0f9ff',
          fontFamily: 'system-ui, -apple-system, sans-serif',
          fontSize: '14px',
        },
        flowchart: { curve: 'basis', padding: 20, nodeSpacing: 50, rankSpacing: 50, htmlLabels: true },
        sequence: { actorMargin: 50, width: 150, height: 65, boxMargin: 10 },
        securityLevel: 'loose',
        suppressErrorRendering: false,
      });

      log(`ğŸ”„ Rerendering ${mermaidDiagrams.length} diagrams for theme change...`);

      for (let i = 0; i < mermaidDiagrams.length; i++) {
        const diagram = mermaidDiagrams[i];

        try {
          const renderResult = await mermaid.render(`${diagram.id}-rerender-${Date.now()}`, diagram.code);
          diagram.container.innerHTML = renderResult.svg;
          log(`âœ… Diagram ${i + 1}/${mermaidDiagrams.length} rerendered`);
        } catch (error) {
          logError(`âŒ Failed to rerender diagram ${i}:`, error.message);
        }

        // æ¯æ¸²æŸ“ä¸€ä¸ªå›¾è¡¨åç¨å¾®å»¶è¿Ÿ
        await new Promise(resolve => setTimeout(resolve, 50));
      }

      log('âœ… All diagrams rerendered for theme change');
    } catch (error) {
      logError('âŒ Theme change rerender failed:', error.message);
    }
  });
</script>

<style>
  /* Mermaid åŒ…è£…å®¹å™¨ */
  :global(.mermaid-wrapper) {
    position: relative;
  }

  /* Mermaid å›¾è¡¨æ ·å¼ä¼˜åŒ– */
  :global(.mermaid-diagram svg) {
    max-width: 100%;
    height: auto;
  }

  /* æ”¾å¤§æŒ‰é’®æ ·å¼ */
  :global(.mermaid-zoom-button) {
    position: absolute;
    top: 1rem;
    left: 1rem;
    padding: 0.5rem;
    background-color: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 0.375rem;
    color: var(--text-primary);
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10;
    opacity: 0.7;
  }

  :global(.mermaid-zoom-button:hover) {
    opacity: 1;
    background-color: rgba(74, 222, 128, 0.1);
    border-color: #4ade80;
    color: #4ade80;
    transform: scale(1.1);
  }

  :global(.mermaid-zoom-button:active) {
    transform: scale(0.95);
  }

  /* å“åº”å¼å¤„ç† */
  @media (max-width: 768px) {
    :global(.mermaid-diagram) {
      padding: 1rem !important;
      font-size: 12px;
    }

    :global(.mermaid-zoom-button) {
      top: 0.5rem;
      left: 0.5rem;
      padding: 0.375rem;
    }
  }

  /* æ·±è‰²æ¨¡å¼ä¸‹çš„é¢å¤–æ ·å¼ */
  :global(.dark .mermaid-diagram) {
    background-color: var(--bg-secondary);
  }

  /* æµç¨‹å›¾èŠ‚ç‚¹æ ·å¼å¢å¼º */
  :global(.mermaid-diagram .node rect),
  :global(.mermaid-diagram .node circle),
  :global(.mermaid-diagram .node polygon) {
    stroke-width: 2px;
  }

  /* è¿æ¥çº¿æ ·å¼ */
  :global(.mermaid-diagram .edgePath .path) {
    stroke-width: 2px;
  }

  /* æ–‡æœ¬æ ·å¼ */
  :global(.mermaid-diagram .nodeLabel),
  :global(.mermaid-diagram .edgeLabel) {
    font-weight: 500;
  }
</style>
