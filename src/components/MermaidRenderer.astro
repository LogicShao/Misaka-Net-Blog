---
// MermaidRenderer.astro - Mermaid æµç¨‹å›¾æ¸²æŸ“ç»„ä»¶
// ä½¿ç”¨å®¢æˆ·ç«¯ mermaid.js æ¸²æŸ“ ```mermaid ä»£ç å—
---

<!-- Mermaid æ¸²æŸ“å®¹å™¨ -->
<div id="mermaid-container" class="hidden"></div>

<script>
  // ğŸ”§ å¼€å‘/ç”Ÿäº§ç¯å¢ƒæ£€æµ‹
  const IS_DEV = import.meta.env.DEV;
  const log = (...args) => IS_DEV && console.log(...args);
  const logError = (...args) => console.error(...args);  // é”™è¯¯å§‹ç»ˆè¾“å‡º

  // åŠ¨æ€åŠ è½½ Mermaid.js
  async function loadMermaid() {
    if (typeof window.mermaid !== 'undefined') {
      return window.mermaid;
    }

    // ä» CDN åŠ è½½ Mermaid
    return new Promise((resolve, reject) => {
      const script = document.createElement('script');
      script.src = 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js';
      script.type = 'module';
      script.onload = () => {
        if (window.mermaid) {
          resolve(window.mermaid);
        } else {
          reject(new Error('Mermaid failed to load'));
        }
      };
      script.onerror = () => reject(new Error('Failed to load Mermaid script'));
      document.head.appendChild(script);
    });
  }

  // å¸¦è¶…æ—¶çš„ Promise åŒ…è£…å‡½æ•°
  function withTimeout(promise, timeoutMs = 5000) {
    return Promise.race([
      promise,
      new Promise((_, reject) =>
        setTimeout(() => reject(new Error('Rendering timeout after ' + timeoutMs + 'ms')), timeoutMs)
      )
    ]);
  }

  // é˜²æ­¢é‡å¤åˆå§‹åŒ–çš„æ ‡å¿—ä½
  let isInitialized = false;
  let isInitializing = false;

  // ä¿å­˜æ‰€æœ‰ Mermaid å›¾è¡¨çš„åŸå§‹ä»£ç ï¼Œç”¨äºä¸»é¢˜åˆ‡æ¢æ—¶é‡æ–°æ¸²æŸ“
  const mermaidDiagrams = [];

  // åˆå§‹åŒ– Mermaid
  async function initMermaid() {
    // é˜²æ­¢é‡å¤åˆå§‹åŒ–
    if (isInitialized || isInitializing) {
      log('[Mermaid] Already initialized or initializing, skipping...');
      return;
    }

    isInitializing = true;

    try {
      log('[Mermaid] Starting initialization...');

      // æŸ¥æ‰¾æ‰€æœ‰ mermaid ä»£ç å—ï¼ˆShiki ä½¿ç”¨ data-language å±æ€§ï¼‰
      const mermaidBlocks = document.querySelectorAll('pre[data-language="mermaid"] code');

      if (mermaidBlocks.length === 0) {
        log('[Mermaid] No mermaid blocks found');
        isInitializing = false;
        isInitialized = true;
        return;
      }

      log(`[Mermaid] Found ${mermaidBlocks.length} mermaid blocks`);

      const mermaid = await loadMermaid();

      // é…ç½® Mermaid ä¸»é¢˜
      const isDark = document.documentElement.classList.contains('dark');

      mermaid.initialize({
        startOnLoad: false,
        theme: isDark ? 'dark' : 'default',
        themeVariables: {
          primaryColor: isDark ? '#4ade80' : '#4ade80',
          primaryTextColor: isDark ? '#f0f8ff' : '#0f172a',
          primaryBorderColor: isDark ? '#4ade80' : '#4ade80',
          lineColor: isDark ? '#38bdf8' : '#38bdf8',
          secondaryColor: isDark ? '#1e293b' : '#e0f2fe',
          tertiaryColor: isDark ? '#0f172a' : '#f0f9ff',
          fontFamily: 'system-ui, -apple-system, sans-serif',
          fontSize: '14px',
        },
        flowchart: {
          curve: 'basis',
          padding: 20,
          nodeSpacing: 50,
          rankSpacing: 50,
          htmlLabels: true,  // å¯ç”¨ HTML æ ‡ç­¾æ”¯æŒ
        },
        sequence: {
          actorMargin: 50,
          width: 150,
          height: 65,
          boxMargin: 10,
        },
        // å¯ç”¨æ•°å­¦å…¬å¼æ”¯æŒ
        securityLevel: 'loose',  // å…è®¸ HTML å’Œæ•°å­¦å…¬å¼
        suppressErrorRendering: false,
      });

      // æ¸²æŸ“æ¯ä¸ª mermaid å—
      for (let i = 0; i < mermaidBlocks.length; i++) {
        const block = mermaidBlocks[i];
        const pre = block.parentElement;
        // æå–çº¯æ–‡æœ¬å†…å®¹ï¼ˆå»é™¤ Shiki æ·»åŠ çš„ HTML æ ‡ç­¾ï¼‰
        const code = block.textContent || block.innerText || '';

        // è·³è¿‡ç©ºä»£ç å—
        if (!code.trim()) {
          log(`[Mermaid] Skipping empty diagram ${i}`);
          continue;
        }

        try {
          // åˆ›å»ºå¤–å±‚åŒ…è£…å®¹å™¨
          const wrapper = document.createElement('div');
          wrapper.className = 'mermaid-wrapper my-8 relative';

          // åˆ›å»ºæ¸²æŸ“å®¹å™¨
          const container = document.createElement('div');
          container.className = 'mermaid-diagram flex justify-center';
          container.style.cssText = `
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            padding: 2rem;
            overflow-x: auto;
          `;

          // ä½¿ç”¨ Mermaid æ¸²æŸ“ï¼ˆå¸¦ 5ç§’è¶…æ—¶ä¿æŠ¤ï¼Œå‡å°‘ç­‰å¾…æ—¶é—´ï¼‰
          log(`[Mermaid] Rendering diagram ${i}...`);
          const renderResult = await withTimeout(
            mermaid.render(`mermaid-${i}-${Date.now()}`, code),
            5000  // 5ç§’è¶…æ—¶ï¼ˆä»10ç§’å‡å°‘ï¼‰
          );
          const { svg } = renderResult;
          container.innerHTML = svg;
          log(`[Mermaid] Diagram ${i} rendered successfully`);

          // æ¸²æŸ“æ•°å­¦å…¬å¼ï¼ˆå¦‚æœé¡µé¢å·²åŠ è½½ KaTeXï¼‰
          if (typeof window.katex !== 'undefined') {
            renderMathInSVG(container);
          } else {
            // å°è¯•åŠ è½½ KaTeX å¹¶æ¸²æŸ“æ•°å­¦å…¬å¼
            loadKaTeXAndRender(container);
          }

          // åˆ›å»ºæ”¾å¤§æŒ‰é’®
          const zoomButton = document.createElement('button');
          zoomButton.className = 'mermaid-zoom-button';
          zoomButton.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3.75v4.5m0-4.5h4.5m-4.5 0L9 9M3.75 20.25v-4.5m0 4.5h4.5m-4.5 0L9 15M20.25 3.75h-4.5m4.5 0v4.5m0-4.5L15 9m5.25 11.25h-4.5m4.5 0v-4.5m0 4.5L15 15" />
            </svg>
          `;
          zoomButton.setAttribute('aria-label', 'å…¨å±æŸ¥çœ‹æµç¨‹å›¾');
          zoomButton.setAttribute('title', 'å…¨å±æŸ¥çœ‹ (æ”¯æŒæ‹–æ‹½å’Œç¼©æ”¾)');

          // ç‚¹å‡»æŒ‰é’®æ—¶è§¦å‘è‡ªå®šä¹‰äº‹ä»¶
          zoomButton.addEventListener('click', () => {
            const svgElement = container.querySelector('svg');
            if (svgElement) {
              window.dispatchEvent(new CustomEvent('open-mermaid-viewer', {
                detail: {
                  svg: svgElement.outerHTML,
                  id: `mermaid-${i}`
                }
              }));
            }
          });

          // ç»„è£…å®¹å™¨
          wrapper.appendChild(container);
          wrapper.appendChild(zoomButton);

          // æ›¿æ¢åŸå§‹ä»£ç å—
          if (pre && pre.parentElement) {
            pre.parentElement.replaceChild(wrapper, pre);

            // ğŸ¯ ä¿å­˜å›¾è¡¨ä¿¡æ¯ï¼Œç”¨äºä¸»é¢˜åˆ‡æ¢æ—¶é‡æ–°æ¸²æŸ“
            mermaidDiagrams.push({
              id: `mermaid-${i}`,
              code: code,
              wrapper: wrapper,
              container: container
            });
          }
        } catch (error) {
          logError(`[Mermaid] Rendering error for diagram ${i}:`, error);
          logError(`[Mermaid] Failed code (first 200 chars):`, code.substring(0, 200));

          // æ¸²æŸ“å¤±è´¥æ—¶ä¿ç•™åŸå§‹ä»£ç å—ï¼Œä½†æ·»åŠ é”™è¯¯æç¤º
          const errorDiv = document.createElement('div');
          errorDiv.className = 'mermaid-error p-4 my-4 rounded-lg';
          errorDiv.style.cssText = `
            background-color: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: var(--text-primary);
          `;
          errorDiv.innerHTML = `
            <p class="font-semibold mb-2">âš ï¸ Mermaid æ¸²æŸ“å¤±è´¥ (å›¾è¡¨ #${i})</p>
            <p class="text-sm mb-2">é”™è¯¯ä¿¡æ¯: ${error.message}</p>
            <details class="text-xs">
              <summary class="cursor-pointer hover:text-misaka-blue">æŸ¥çœ‹ä»£ç </summary>
              <pre class="mt-2 p-2 bg-black bg-opacity-20 rounded overflow-x-auto"><code>${code}</code></pre>
            </details>
          `;
          if (pre && pre.parentElement) {
            pre.parentElement.insertBefore(errorDiv, pre);
            // ä»ç„¶ç§»é™¤åŸå§‹çš„ pre æ ‡ç­¾ï¼Œé¿å…é‡å¤æ˜¾ç¤º
            pre.remove();
          }

          // ç»§ç»­å¤„ç†ä¸‹ä¸€ä¸ªå›¾è¡¨ï¼Œä¸è¦å› ä¸ºä¸€ä¸ªå¤±è´¥è€Œä¸­æ–­
          continue;
        }
      }
    } catch (error) {
      logError('[Mermaid] Failed to initialize:', error);
      isInitializing = false;
    } finally {
      // æ ‡è®°åˆå§‹åŒ–å®Œæˆ
      if (!isInitialized) {
        isInitialized = true;
        isInitializing = false;
        log('[Mermaid] Initialization complete');
      }
    }
  }

  // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initMermaid);
  } else {
    initMermaid();
  }

  // View Transitions æ”¯æŒ - é¡µé¢å¯¼èˆªåé‡æ–°åˆå§‹åŒ–
  document.addEventListener('astro:page-load', () => {
    log('[Mermaid] astro:page-load event fired, reinitializing...');

    // é‡ç½®åˆå§‹åŒ–çŠ¶æ€
    isInitialized = false;
    isInitializing = false;

    // æ¸…ç©ºå·²ä¿å­˜çš„å›¾è¡¨åˆ—è¡¨
    mermaidDiagrams.length = 0;

    // é‡æ–°åˆå§‹åŒ–
    initMermaid();
  });

  // åœ¨ SVG ä¸­æ¸²æŸ“æ•°å­¦å…¬å¼
  function renderMathInSVG(container) {
    if (typeof window.katex === 'undefined') return;

    const svgElement = container.querySelector('svg');
    if (!svgElement) return;

    // æŸ¥æ‰¾æ‰€æœ‰åŒ…å«æ•°å­¦å…¬å¼çš„æ–‡æœ¬å…ƒç´ 
    const textElements = svgElement.querySelectorAll('text, tspan');

    textElements.forEach((textEl) => {
      const text = textEl.textContent || '';

      // æ£€æŸ¥æ˜¯å¦åŒ…å«æ•°å­¦å…¬å¼ï¼ˆ$ ... $ï¼‰
      if (text.includes('$')) {
        try {
          // æ›¿æ¢è¡Œå†…å…¬å¼ $...$
          let newHtml = text.replace(/\$([^$]+)\$/g, (match, formula) => {
            try {
              return window.katex.renderToString(formula, {
                throwOnError: false,
                displayMode: false,
              });
            } catch (e) {
              return match; // æ¸²æŸ“å¤±è´¥æ—¶ä¿ç•™åŸæ–‡
            }
          });

          // æ›¿æ¢å—çº§å…¬å¼ $$...$$
          newHtml = newHtml.replace(/\$\$([^$]+)\$\$/g, (match, formula) => {
            try {
              return window.katex.renderToString(formula, {
                throwOnError: false,
                displayMode: true,
              });
            } catch (e) {
              return match;
            }
          });

          // å¦‚æœæœ‰å˜åŒ–ï¼Œæ›´æ–°å…ƒç´ 
          if (newHtml !== text) {
            // åˆ›å»ºä¸´æ—¶å®¹å™¨æ¥è§£æ HTML
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = newHtml;

            // å°† HTML è½¬æ¢ä¸º SVG foreignObject
            const foreignObject = document.createElementNS('http://www.w3.org/2000/svg', 'foreignObject');
            const bbox = textEl.getBBox();

            foreignObject.setAttribute('x', bbox.x);
            foreignObject.setAttribute('y', bbox.y - bbox.height * 0.8);
            foreignObject.setAttribute('width', bbox.width * 3);
            foreignObject.setAttribute('height', bbox.height * 2);

            const div = document.createElement('div');
            div.style.cssText = `
              font-size: ${window.getComputedStyle(textEl).fontSize};
              color: ${window.getComputedStyle(textEl).fill || window.getComputedStyle(textEl).color};
            `;
            div.innerHTML = newHtml;

            foreignObject.appendChild(div);
            textEl.parentNode?.replaceChild(foreignObject, textEl);
          }
        } catch (error) {
          console.warn('Failed to render math in SVG:', error);
        }
      }
    });
  }

  // åŠ è½½ KaTeX å¹¶æ¸²æŸ“æ•°å­¦å…¬å¼
  async function loadKaTeXAndRender(container) {
    if (typeof window.katex !== 'undefined') {
      renderMathInSVG(container);
      return;
    }

    try {
      // åŠ è½½ KaTeX CSS
      if (!document.querySelector('link[href*="katex"]')) {
        const katexCSS = document.createElement('link');
        katexCSS.rel = 'stylesheet';
        katexCSS.href = 'https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css';
        document.head.appendChild(katexCSS);
      }

      // åŠ è½½ KaTeX JS
      const script = document.createElement('script');
      script.src = 'https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js';
      script.onload = () => {
        renderMathInSVG(container);
      };
      document.head.appendChild(script);
    } catch (error) {
      console.error('Failed to load KaTeX:', error);
    }
  }

  // ğŸ¯ é‡æ–°æ¸²æŸ“æ‰€æœ‰å·²ä¿å­˜çš„ Mermaid å›¾è¡¨ï¼ˆç”¨äºä¸»é¢˜åˆ‡æ¢ï¼‰
  async function rerenderMermaidDiagrams() {
    if (mermaidDiagrams.length === 0) {
      log('[Mermaid] No diagrams to rerender');
      return;
    }

    log(`[Mermaid] Rerendering ${mermaidDiagrams.length} diagrams...`);

    const mermaid = await loadMermaid();

    // é‡æ–°é…ç½® Mermaid ä¸»é¢˜
    const isDark = document.documentElement.classList.contains('dark');
    mermaid.initialize({
      startOnLoad: false,
      theme: isDark ? 'dark' : 'default',
      themeVariables: {
        primaryColor: isDark ? '#4ade80' : '#4ade80',
        primaryTextColor: isDark ? '#f0f8ff' : '#0f172a',
        primaryBorderColor: isDark ? '#4ade80' : '#4ade80',
        lineColor: isDark ? '#38bdf8' : '#38bdf8',
        secondaryColor: isDark ? '#1e293b' : '#e0f2fe',
        tertiaryColor: isDark ? '#0f172a' : '#f0f9ff',
        fontFamily: 'system-ui, -apple-system, sans-serif',
        fontSize: '14px',
      },
      flowchart: {
        curve: 'basis',
        padding: 20,
        nodeSpacing: 50,
        rankSpacing: 50,
        htmlLabels: true,
      },
      sequence: {
        actorMargin: 50,
        width: 150,
        height: 65,
        boxMargin: 10,
      },
      securityLevel: 'loose',
      suppressErrorRendering: false,
    });

    // éå†æ‰€æœ‰ä¿å­˜çš„å›¾è¡¨å¹¶é‡æ–°æ¸²æŸ“
    for (let i = 0; i < mermaidDiagrams.length; i++) {
      const diagram = mermaidDiagrams[i];

      try {
        log(`[Mermaid] Rerendering diagram ${i} (${diagram.id})...`);

        // é‡æ–°æ¸²æŸ“ï¼ˆå¸¦è¶…æ—¶ä¿æŠ¤ï¼‰
        const renderResult = await withTimeout(
          mermaid.render(`${diagram.id}-rerender-${Date.now()}`, diagram.code),
          5000  // 5ç§’è¶…æ—¶ï¼ˆä»10ç§’å‡å°‘ï¼‰
        );
        const { svg } = renderResult;

        // æ›´æ–°å®¹å™¨å†…å®¹
        diagram.container.innerHTML = svg;

        // é‡æ–°æ¸²æŸ“æ•°å­¦å…¬å¼
        if (typeof window.katex !== 'undefined') {
          renderMathInSVG(diagram.container);
        }

        log(`[Mermaid] Diagram ${i} rerendered successfully`);
      } catch (error) {
        logError(`[Mermaid] Failed to rerender diagram ${i}:`, error);
      }
    }

    log('[Mermaid] All diagrams rerendered');
  }

  // ç›‘å¬ä¸»é¢˜åˆ‡æ¢è‡ªå®šä¹‰äº‹ä»¶ï¼Œå®‰å…¨åœ°é‡æ–°æ¸²æŸ“ Mermaid å›¾è¡¨
  let isRerendering = false;  // é˜²æ­¢é‡å¤æ¸²æŸ“æ ‡å¿—ä½

  window.addEventListener('theme-changed', async (event) => {
    const { theme, timestamp } = event.detail;
    log(`[Mermaid] Received theme-changed event: ${theme} at ${timestamp}`);

    // é˜²æ­¢é‡å¤æ¸²æŸ“
    if (isRerendering) {
      log('[Mermaid] Already rerendering, skipping...');
      return;
    }

    // å¦‚æœè¿˜æ²¡æœ‰åˆå§‹åŒ–å®Œæˆï¼Œä¸è¿›è¡Œé‡æ–°æ¸²æŸ“
    if (!isInitialized) {
      log('[Mermaid] Not initialized yet, skipping rerender');
      return;
    }

    isRerendering = true;

    try {
      log('[Mermaid] Starting theme-based rerender...');

      // å»¶è¿Ÿ 150ms æ‰§è¡Œï¼Œé¿å… DOM è¿˜åœ¨å˜åŒ–æ—¶æ¸²æŸ“
      await new Promise(resolve => setTimeout(resolve, 150));

      // é‡æ–°æ¸²æŸ“æ‰€æœ‰å›¾è¡¨
      await rerenderMermaidDiagrams();

      log('[Mermaid] Theme-based rerender complete');
    } catch (error) {
      logError('[Mermaid] Failed to rerender after theme change:', error);
    } finally {
      isRerendering = false;
    }
  });
</script>

<style>
  /* Mermaid åŒ…è£…å®¹å™¨ */
  :global(.mermaid-wrapper) {
    position: relative;
  }

  /* Mermaid å›¾è¡¨æ ·å¼ä¼˜åŒ– */
  :global(.mermaid-diagram svg) {
    max-width: 100%;
    height: auto;
  }

  /* æ”¾å¤§æŒ‰é’®æ ·å¼ */
  :global(.mermaid-zoom-button) {
    position: absolute;
    top: 1rem;
    left: 1rem;
    padding: 0.5rem;
    background-color: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 0.375rem;
    color: var(--text-primary);
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10;
    opacity: 0.7;
  }

  :global(.mermaid-zoom-button:hover) {
    opacity: 1;
    background-color: rgba(74, 222, 128, 0.1);
    border-color: #4ade80;
    color: #4ade80;
    transform: scale(1.1);
  }

  :global(.mermaid-zoom-button:active) {
    transform: scale(0.95);
  }

  /* å“åº”å¼å¤„ç† */
  @media (max-width: 768px) {
    :global(.mermaid-diagram) {
      padding: 1rem !important;
      font-size: 12px;
    }

    :global(.mermaid-zoom-button) {
      top: 0.5rem;
      left: 0.5rem;
      padding: 0.375rem;
    }
  }

  /* æ·±è‰²æ¨¡å¼ä¸‹çš„é¢å¤–æ ·å¼ */
  :global(.dark .mermaid-diagram) {
    background-color: var(--bg-secondary);
  }

  /* æµç¨‹å›¾èŠ‚ç‚¹æ ·å¼å¢å¼º */
  :global(.mermaid-diagram .node rect),
  :global(.mermaid-diagram .node circle),
  :global(.mermaid-diagram .node polygon) {
    stroke-width: 2px;
  }

  /* è¿æ¥çº¿æ ·å¼ */
  :global(.mermaid-diagram .edgePath .path) {
    stroke-width: 2px;
  }

  /* æ–‡æœ¬æ ·å¼ */
  :global(.mermaid-diagram .nodeLabel),
  :global(.mermaid-diagram .edgeLabel) {
    font-weight: 500;
  }
</style>
