---
// Misaka Network - 滚动进度条组件
// 显示文章阅读进度，克制简洁的设计
---

<!-- 进度条容器 -->
<div class="scroll-progress-container">
  <div class="scroll-progress-bar"></div>
</div>

<style>
  .scroll-progress-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 4px;
    background-color: transparent;
    z-index: 10000; /* 确保在 Header (z-50) 之上 */
    pointer-events: none;
  }

  .scroll-progress-bar {
    height: 100%;
    width: 0%;
    background: linear-gradient(90deg, var(--misaka-circuit), var(--misaka-blue));
    /* 移除 transition，使用 RAF 直接更新更流畅 */
  }

  /* 深色模式增强发光效果 */
  .dark .scroll-progress-bar {
    box-shadow: 0 0 10px rgba(74, 222, 128, 0.35), 0 0 6px rgba(0, 191, 255, 0.3);
  }

  /* 浅色模式减弱发光 */
  :root:not(.dark) .scroll-progress-bar {
    box-shadow: 0 0 6px rgba(74, 222, 128, 0.35), 0 0 4px rgba(56, 189, 248, 0.3);
  }
</style>

<script>
  /**
   * 初始化滚动进度条
   * 单一职责：计算并更新进度条宽度
   */
  function initScrollProgress() {
    const progressBar = document.querySelector('.scroll-progress-bar') as HTMLElement | null;

    if (!progressBar) {
      if (import.meta.env.DEV) {
        console.warn('[ScrollProgress] Progress bar element not found');
      }
      return;
    }

    let ticking = false;

    /**
     * 计算并更新滚动进度
     * 性能优化：仅在必要时更新 DOM
     */
    function updateProgress() {
      const windowHeight = window.innerHeight;
      const documentHeight = document.documentElement.scrollHeight;
      const scrollTop = window.scrollY;
      const scrollableHeight = documentHeight - windowHeight;

      // 计算进度百分比（0-100）
      const progress = scrollableHeight > 0
        ? Math.min((scrollTop / scrollableHeight) * 100, 100)
        : 0;

      // 直接更新宽度，避免 CSS transition 导致的延迟
      progressBar.style.width = `${progress}%`;

      ticking = false;
    }

    /**
     * 滚动事件处理器
     * 使用 requestAnimationFrame 节流，确保 60fps 性能
     */
    function handleScroll() {
      if (!ticking) {
        requestAnimationFrame(updateProgress);
        ticking = true;
      }
    }

    // 初始化进度
    updateProgress();

    // 监听滚动事件（passive 优化）
    window.addEventListener('scroll', handleScroll, {passive: true});

    // 窗口尺寸变化时重新计算
    window.addEventListener('resize', () => {
      if (!ticking) {
        requestAnimationFrame(updateProgress);
        ticking = true;
      }
    }, {passive: true});

    if (import.meta.env.DEV) {
      console.log('[ScrollProgress] ✅ Initialized');
    }
  }

  // DOMContentLoaded 或立即执行
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initScrollProgress);
  } else {
    initScrollProgress();
  }

  // 支持 Astro View Transitions（页面导航时重新初始化）
  document.addEventListener('astro:page-load', initScrollProgress);
</script>
